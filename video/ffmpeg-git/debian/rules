#!/usr/bin/make -f

DEB_HOST_ARCH ?= $(shell dpkg-architecture -qDEB_HOST_ARCH)

export V=1
export DEB_BUILD_MAINT_OPTIONS=hardening=+all

CFLAGS   := -O3 $(filter-out -g -O2,$(shell dpkg-buildflags --get CFLAGS))
CXXFLAGS := -O3 $(filter-out -g -O2,$(shell dpkg-buildflags --get CXXFLAGS))
LDFLAGS  := -Wl,-z,relro -Wl,-z,defs -Wl,--as-needed

X264_CONFIG := \
	--disable-cli \
	--enable-static \
	--disable-avs \
	--disable-swscale \
	--disable-lavf \
	--disable-ffms \
	--disable-gpac \
	--disable-lsmash

X265_CONFIG := \
	-DENABLE_CLI=OFF \
	-DENABLE_SHARED=OFF \
	-DENABLE_AGGRESSIVE_CHECKS=ON \
	-DENABLE_PIC=OFF

ifneq ($(DEB_HOST_ARCH),amd64)
X265_CONFIG += -DENABLE_ASSEMBLY=OFF
endif

FFMPEG_CONFIG := \
	--prefix=/usr \
	--disable-debug \
	--enable-avresample \
	--enable-pthreads \
	--enable-runtime-cpudetect \
	--enable-avisynth \
	--enable-libass \
	--enable-libbluray \
	--enable-libdc1394 \
	--enable-libfreetype \
	--enable-frei0r \
	--enable-gnutls \
	--enable-libgsm \
	--enable-libmp3lame \
	--enable-openal \
	--enable-libopus \
	--enable-libpulse \
	--enable-librtmp \
	--enable-libschroedinger \
	--enable-libspeex \
	--enable-libtheora \
	--enable-vaapi \
	--enable-vdpau \
	--enable-libvorbis \
	--enable-libvpx \
	--enable-libwavpack \
	--enable-libwebp \
	--enable-gpl \
	--enable-postproc \
	--enable-libcdio \
	--enable-libxcb \
	--enable-libx264 \
	--enable-libx265 \
	--enable-libxvid \
	--enable-version3 \
	--enable-libopencore-amrnb \
	--enable-libopencore-amrwb \
	--enable-libvo-aacenc \
	--enable-libvo-amrwbenc \
	--enable-nonfree \
	--enable-libfdk-aac


%:
	dh ${@} --parallel --with autoreconf

override_dh_autoreconf:
	dh_autoreconf autoreconf -- -ivf fdk-aac

override_dh_auto_clean:
	dh_auto_clean -Dfdk-aac
	[ ! -f x264/config.mak ] || dh_auto_clean -Dx264
	[ ! -f ffmpeg/config.mak ] || dh_auto_clean -Dffmpeg
	rm -rf x265_8bit x265_10bit x265_12bit libs

override_dh_auto_configure:

override_dh_auto_build:
	# fdk-aac
	cd fdk-aac && \
	./configure \
		--prefix=$(CURDIR)/libs \
		--enable-static=yes \
		--enable-shared=no
	dh_auto_build -Dfdk-aac
	$(MAKE) -C fdk-aac install

	# x264
	cd x264 && \
	./configure --prefix=$(CURDIR)/libs $(X264_CONFIG)
	dh_auto_build -Dx264
	$(MAKE) -C x264 install
	dh_auto_clean -Dx264

	# x265 main10 main12
	dh_auto_configure \
		--buildsystem=cmake \
		--sourcedirectory=x265/source \
		--builddirectory=x265_12bit \
		-- $(X265_CONFIG) \
		-DHIGH_BIT_DEPTH=ON \
		-DEXPORT_C_API=OFF \
		-DMAIN12=ON
	dh_auto_configure \
		--buildsystem=cmake \
		--sourcedirectory=x265/source \
		--builddirectory=x265_10bit \
		-- $(X265_CONFIG) \
		-DHIGH_BIT_DEPTH=ON \
		-DEXPORT_C_API=OFF
	dh_auto_build --builddirectory=x265_12bit
	dh_auto_build --builddirectory=x265_10bit

	# x265 main
	mkdir x265_8bit
	cp x265_10bit/libx265.a x265_8bit/libx265_main10.a
	cp x265_12bit/libx265.a x265_8bit/libx265_main12.a
	dh_auto_configure \
		--buildsystem=cmake \
		--sourcedirectory=x265/source \
		--builddirectory=x265_8bit \
		-- $(X265_CONFIG) \
		-DCMAKE_INSTALL_PREFIX=$(CURDIR)/libs \
		-DLIB_INSTALL_DIR=lib \
		-DHIGH_BIT_DEPTH=OFF \
		-DEXTRA_LIB="x265_main10.a;x265_main12.a;-ldl" \
		-DEXTRA_LINK_FLAGS="-L$(CURDIR)/x265_8bit" \
		-DLINKED_10BIT=ON -DLINKED_12BIT=ON \
		$(X265_CONFIG)
	dh_auto_build -Dx265_8bit
	$(MAKE) -C x265_8bit install
	cp x265_8bit/libx265_main*.a $(CURDIR)/libs/lib
	sed -e 's|@PREFIX@|$(CURDIR)/libs|g; s|@VERSION@|$(shell cat x265/VERSION)|g' \
		debian/x265.pc.in > $(CURDIR)/libs/lib/pkgconfig/x265.pc

	# ffmpeg
	cd ffmpeg && \
		CFLAGS="$(CFLAGS) -I$(CURDIR)/libs/include" \
		LDFLAGS="$(LDFLAGS) -L$(CURDIR)/libs/lib" \
		PKG_CONFIG_PATH="$(CURDIR)/libs/lib/pkgconfig" \
		./configure $(FFMPEG_CONFIG)
	dh_auto_build -Dffmpeg
	dh_auto_build -Dffmpeg -- apidoc
	dh_auto_build -Dffmpeg -- tools/qt-faststart

override_dh_auto_install:
	dh_auto_install -Dffmpeg

override_dh_installdocs:
	dh_installdocs -A ffmpeg/CREDITS ffmpeg/MAINTAINERS

override_dh_installchangelogs:
	dh_installchangelogs -A ffmpeg/Changelog

